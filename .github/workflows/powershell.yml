# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
#
# https://github.com/microsoft/action-psscriptanalyzer
# For more information on PSScriptAnalyzer in general, see
# https://github.com/PowerShell/PSScriptAnalyzer

name: PSScriptAnalyzer

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '31 10 * * 0'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    name: PSScriptAnalyzer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install PSScriptAnalyzer and ConvertToSARIF
        shell: pwsh
        run: |
          # Install modules in CurrentUser scope to avoid permission issues
          # Use -Force and -AllowClobber to ensure clean installation
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber
          Install-Module -Name ConvertToSARIF -Force -Scope CurrentUser -AllowClobber
          
          # Verify installation
          Get-Module -ListAvailable -Name PSScriptAnalyzer, ConvertToSARIF | 
            Select-Object Name, Version | 
            Format-Table -AutoSize

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          # Import modules explicitly in fresh session
          Import-Module -Name PSScriptAnalyzer -Force
          Import-Module -Name ConvertToSARIF -Force
          
          # Run analysis and generate SARIF
          $results = Invoke-ScriptAnalyzer -Path './' -Recurse -Settings 'PSScriptAnalyzerSettings.psd1'
          
          # Filter out TypeNotFound warnings before conversion
          # PSScriptAnalyzer analyzes files independently and cannot resolve 
          # classes defined in dot-sourced files, causing false TypeNotFound warnings
          $filteredResults = $results | Where-Object { $_.RuleName -ne 'TypeNotFound' }
          
          # Convert to SARIF format
          $filteredResults | ConvertTo-SARIF -FilePath 'results.sarif'
          
          # Output issues using GitHub Actions workflow commands
          foreach ($issue in $filteredResults) {
            $file = $issue.ScriptPath -replace [regex]::Escape($PWD.Path + [IO.Path]::DirectorySeparatorChar), ''
            $line = $issue.Line
            $col = $issue.Column
            $msg = $issue.Message -replace '%', '%25' -replace "`r", '%0D' -replace "`n", '%0A'
            $rule = $issue.RuleName
            
            switch ($issue.Severity) {
              'Error' {
                Write-Host "::error file=$file,line=$line,col=$col,title=$rule::$msg"
              }
              'Warning' {
                Write-Host "::warning file=$file,line=$line,col=$col,title=$rule::$msg"
              }
              'Information' {
                Write-Host "::notice file=$file,line=$line,col=$col,title=$rule::$msg"
              }
            }
          }
          
          # Report summary
          $errorCount = ($filteredResults | Where-Object { $_.Severity -eq 'Error' }).Count
          $warningCount = ($filteredResults | Where-Object { $_.Severity -eq 'Warning' }).Count
          $infoCount = ($filteredResults | Where-Object { $_.Severity -eq 'Information' }).Count
          
          Write-Host ""
          Write-Host "PSScriptAnalyzer Results (TypeNotFound warnings excluded):"
          Write-Host "  Errors: $errorCount"
          Write-Host "  Warnings: $warningCount"
          Write-Host "  Information: $infoCount"
          Write-Host ""
          Write-Host "SARIF file generated: results.sarif"

      # Upload the SARIF file generated in the previous step
      - name: Upload SARIF results file
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        with:
          sarif_file: results.sarif
